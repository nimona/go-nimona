---
- name: Create and start nimona bootstrap container
  docker_container:
    name: bootstrap
    image: "ghcr.io/nimona/nimona:{{ bootstrap_nimona_version }}"
    pull: yes
    recreate: '{{ bootstrap_nimona_version == "latest" }}'
    restart_policy: always
    state: started
    privileged: yes
    networks_cli_compatible: yes
    env:
      NIMONA_LOG_LEVEL: "info"
      NIMONA_PEER_BIND_ADDRESS: "0.0.0.0:{{ bootstrap_peer_port }}"
      NIMONA_PEER_ANNOUNCE_ADDRESS: "{{ bootstrap_peer_announce_address }}"
      NIMONA_PEER_PRIVATE_KEY: "{{ vault_nimona_bootstrap_private_keys[inventory_hostname] }}"
    published_ports:
      - "127.0.0.1:{{ bootstrap_peer_port }}:{{ bootstrap_peer_port }}"
      - "127.0.0.1:{{ bootstrap_metrics_port }}:{{ bootstrap_metrics_port }}"

- name: Configure caddy
  import_role:
    name: metrics_site
  vars:
    metrics_site_name: bootstrap
    metrics_site_host_path: /metrics/bootstrap
    metrics_site_upstream_path: /metrics
    metrics_site_upstream: "127.0.0.1:{{ bootstrap_metrics_port }}"
    metrics_site_users: "{{ metrics_users }}"
